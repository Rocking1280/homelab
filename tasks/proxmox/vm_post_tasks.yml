---
# After successful creation and bootstrapping, we want to remove the cloud init drive.
# It is defined in the defaults, if it changes device name/numbering, adjust there.
- name: Remove Cloud-init drives from vms
  shell:
    cmd: "qm set {{ vm.id }} --delete {{ vm.cloudinit_drive | default(vm_defaults.cloudinit_drive) }}"
  when: cloned_vm.changed

- name: Restart VM's
  community.general.proxmox_kvm:
    node: "{{ pve.proxmox_node }}"
    api_user: "{{ pve.proxmox_api_user }}"
    api_password: "{{ pve.proxmox_api_pass }}"
    api_host: "{{ proxmox_ip }}"
    name: "{{ vm.name | default(inventory_hostname_short) }}"
    state: restarted
  when: cloned_vm.changed

- name: Wait until vm(s) comes back online
  wait_for:
    port: 22
    host: "{{ vm_ip_address }}"
    search_regex: OpenSSH
  delegate_to: localhost
