---
version: "3"

tasks:

  main:
    desc: üñ•Ô∏è Main Proxmox playbook
    dir: provision/ansible
    cmds:
      - task: :generate-ansible-inventory
      - "{{.ANSIBLE_PLAYBOOK_CMD}} {{.ANSIBLE_PLAYBOOK_DIR}}/proxmox.yml {{.CLI_ARGS}}"

  run-tags:
    desc: üñ•Ô∏è Run only the tags passed in separated by comma
    dir: provision/ansible
    cmds:
      - task: :generate-ansible-inventory
      - "{{.ANSIBLE_PLAYBOOK_CMD}} --tags {{.CLI_ARGS}} -e \"{{.CLI_ARGS}}=true\" {{.ANSIBLE_PLAYBOOK_DIR}}/proxmox.yml"

  run-tags-v:
    desc: üñ•Ô∏è VERBOSE - Run only the tags passed in separated by comma
    dir: provision/ansible
    cmds:
      - task: :generate-ansible-inventory
      - "{{.ANSIBLE_PLAYBOOK_CMD}} --tags {{.CLI_ARGS}} -e \"{{.CLI_ARGS}}=true\" {{.ANSIBLE_PLAYBOOK_DIR}}/proxmox.yml -vvvv"

  ubuntu-vm-template:
    desc: üñ•Ô∏è Create Ubuntu VM Template in Proxmox.
    dir: provision/ansible
    cmds:
      - task: :generate-ansible-inventory
      - "{{.ANSIBLE_PLAYBOOK_CMD}} --tags \"create_ubuntu_vm_template\" -e \"create_ubuntu_vm_template=true\" {{.ANSIBLE_PLAYBOOK_DIR}}/proxmox.yml {{.CLI_ARGS}}"

  force-ubuntu-vm-template:
    desc: üñ•Ô∏è Force (re)create/(re)download Ubuntu VM Template in Proxmox from public ubuntu cloud-init image. Essentially if you want to remake the image from scratch, make this target.
    dir: provision/ansible
    cmds:
      - task: :generate-ansible-inventory
      - "{{.ANSIBLE_PLAYBOOK_CMD}} --tags \"create_ubuntu_vm_template\" -e \"create_ubuntu_vm_template=true force_template_rebuild=true\" {{.ANSIBLE_PLAYBOOK_DIR}}/proxmox.yml {{.CLI_ARGS}}"

  debian-vm-template:
    desc: üñ•Ô∏è Create Debian VM Template in Proxmox.
    dir: provision/ansible
    cmds:
      - task: :generate-ansible-inventory
      - "{{.ANSIBLE_PLAYBOOK_CMD}} --tags \"create_debian_vm_template\" -e \"create_debian_vm_template=true\" {{.ANSIBLE_PLAYBOOK_DIR}}/proxmox.yml {{.CLI_ARGS}}"

  force-debian-vm-template:
    desc: üñ•Ô∏è Force (re)create/(re)download Debian VM Template in Proxmox from public debian cloud-init image. Essentially if you want to remake the image from scratch, make this target.
    dir: provision/ansible
    cmds:
      - task: :generate-ansible-inventory
      - "{{.ANSIBLE_PLAYBOOK_CMD}} --tags \"create_debian_vm_template\" -e \"create_debian_vm_template=true force_template_rebuild=true\" {{.ANSIBLE_PLAYBOOK_DIR}}/proxmox.yml {{.CLI_ARGS}}"

  provision-tags:
    desc: üñ•Ô∏è Provision based on tags passed in. Check tags on the plays in `playbooks/proxmox.yml` for more info. e.g. `make proxmox-provision-blah`
    dir: provision/ansible
    cmds:
      - task: :generate-ansible-inventory
      - "{{.ANSIBLE_PLAYBOOK_CMD}} -e \"provision_vms=true\" --tags {{.CLI_ARGS}} {{.ANSIBLE_PLAYBOOK_DIR}}/proxmox.yml"

  provision-docker:
    desc: üñ•Ô∏è Provision docker vm.
    dir: provision/ansible
    cmds:
      - task: :generate-ansible-inventory
      - "{{.ANSIBLE_PLAYBOOK_CMD}} --tags proxmox-provision-docker {{.ANSIBLE_PLAYBOOK_DIR}}/vm.yml {{.CLI_ARGS}}"
