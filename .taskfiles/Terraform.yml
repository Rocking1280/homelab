---
version: "3"

vars:

  TERRAFORM_DIR: "provision/terraform"
  TF_DIR_CF: "{{.TERRAFORM_DIR}}/cloudflare"
  TF_DIR_PVE: "{{.TERRAFORM_DIR}}/proxmox"
  TF_DIR_DOPPLER: "{{.TERRAFORM_DIR}}/doppler"
  TF_DIR_FLUX: "{{.TERRAFORM_DIR}}/flux"
  TF_VARS_FILE: "myvars.tfvars"
  TF_VARS_CMD: "-var-file=../{{.TF_VARS_FILE}}"

tasks:

  tfvars:
    desc: Write tfvars file for terraform to use
    aliases: ["t"]
    run: once
    silent: true
    cmds:
      - task: tfvars-doppler-token

  tfvars-doppler-token:
    desc: Write doppler_token tfvar
    dir: provision/terraform
    internal: true
    interactive: true
    status:
      - grep -q 'doppler_token' myvars.tfvars
    cmds:
      - |
        read -p "Enter the Doppler token to be used in terraform (read/write): " doppler_token
        echo "doppler_token = \"$doppler_token\"" >> myvars.tfvars

### Base ###

  tf-init:
    desc: Initialize terraform dependencies
    deps: ['tfvars']
    internal: true
    dir: "{{.TF_DIR_TODO}}"
    cmds:
      - terraform init {{.TF_VARS_CMD}} {{.CLI_ARGS}}

  tf-plan:
    desc: Show the changes terraform will make
    deps: ['tfvars']
    internal: true
    dir: "{{.TF_DIR_TODO}}"
    cmds:
      - terraform plan {{.TF_VARS_CMD}} {{.CLI_ARGS}}

  tf-apply:
    desc: Apply the changes
    deps: ['tfvars']
    internal: true
    dir: "{{.TF_DIR_TODO}}"
    cmds:
      - terraform apply {{.TF_VARS_CMD}} {{.CLI_ARGS}}

### Start ###

  cf-init:
    desc: Initialize Cloudflare terraform dependencies
    aliases: [ci]
    cmds:
      - task: tf-init
        vars:
          TF_DIR_TODO: "{{.TF_DIR_CF}}"

  cf-plan:
    desc: Show the changes Cloudflare terraform will make
    aliases: [cp]
    cmds:
      - task: tf-plan
        vars:
          TF_DIR_TODO: "{{.TF_DIR_CF}}"

  cf-apply:
    desc: Apply the changes to Cloudflare
    aliases: [ca]
    cmds:
      - task: tf-apply
        vars:
          TF_DIR_TODO: "{{.TF_DIR_CF}}"

  pve-init:
    desc: Initialize Proxmox terraform dependencies
    aliases: [pi]
    cmds:
      - task: tf-init
        vars:
          TF_DIR_TODO: "{{.TF_DIR_PVE}}"

  pve-plan:
    desc: Show the changes Proxmox terraform will make
    aliases: [pp]
    cmds:
      - task: tf-plan
        vars:
          TF_DIR_TODO: "{{.TF_DIR_PVE}}"

  pve-apply:
    desc: Apply the changes to Proxmox
    aliases: [pa]
    cmds:
      - task: tf-apply
        vars:
          TF_DIR_TODO: "{{.TF_DIR_PVE}}"

  doppler-init:
    desc: Initialize Proxmox terraform dependencies
    aliases: [di]
    cmds:
      - task: tf-init
        vars:
          TF_DIR_TODO: "{{.TF_DIR_DOPPLER}}"

  doppler-plan:
    desc: Show the changes Proxmox terraform will make
    aliases: [dp]
    cmds:
      - task: tf-plan
        vars:
          TF_DIR_TODO: "{{.TF_DIR_DOPPLER}}"

  doppler-apply:
    desc: Apply the changes to Proxmox
    aliases: [da]
    cmds:
      - task: tf-apply
        vars:
          TF_DIR_TODO: "{{.TF_DIR_DOPPLER}}"

  flux-init:
    desc: Initialize Proxmox terraform dependencies
    aliases: [fi]
    cmds:
      - task: tf-init
        vars:
          TF_DIR_TODO: "{{.TF_DIR_FLUX}}"

  flux-plan:
    desc: Show the changes Proxmox terraform will make
    aliases: [fp]
    cmds:
      - task: tf-plan
        vars:
          TF_DIR_TODO: "{{.TF_DIR_FLUX}}"

  flux-apply:
    desc: Apply the changes to Proxmox
    aliases: [fa]
    cmds:
      - task: tf-apply
        vars:
          TF_DIR_TODO: "{{.TF_DIR_FLUX}}"
